---
title: "Functionalizing NEON raster data"
author: "Sarah Graves"
date: "June 21, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Ojbectives

Start by putting up objectives/tasks that students will be working though:

1. **Import** a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
1. For the CHM, **set values** == 0 to NA (not trees)
1. **Visualize** density and plot vertical cutoff lines.
1. **Classify** the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that <2m is generally grasses / understory, <6m small trees,and the rest are tall trees. A function could import the desired thresholds. Visualize histogram/density and plot vertical cutoff lines.
 (http://neon-workwithdata.github.io/neon-data-institute-2016/R/create-hillshade-R/)
1. **Plot** the classified raster, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/  for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)
1. **Export** the plot figure to a pdf – publishable
1. **Export** the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

# Load packages

```{r LOAD-PACKAGES, message=FALSE}

rm(list = ls())

library(raster)

```


# Import raster

```{r IMPORT-CHM}

chm_file <- "../NEONdata/D17-California/TEAK/2013/lidar/TEAK_lidarCHM.tif"
chm <- raster(chm_file)
plot(chm,
     main="Raw canopy height model")
```


# Set NA values

```{r SET-NA}

par(mfrow=c(1,2))

hist(chm)

# assign NA to zeros because we don't want to analyze zero values (it's not vegetation)
chm[chm==0] <- NA

# check to see if zeros are removed
hist(chm)

par(mfrow=c(1,1))

```


# Set class breaks and classify raster

Classify the CHM to differentiate between short, medium, and tall vegetation.
Use a function to allow for any input of class breaks.

```{r CLASSIFY-FUNCTION}

# function to reclassify raster from provided set of breaks
# input is vector of break values, where each number is the maximum of that break
# output is a matrix object with columns as the min, max, and class number
create_ht_class_matrix <- function(breaks){
  
  # get length of breaks vector to figure out how many classes to have
  brk_len <- length(breaks)
  
  # initialize ht class vector
  ht.class.m <- c(0)
  
  # loop through each break and set the lower and upper bound, and class number
  for(i in 1:brk_len){
    ht.class.m <- c(ht.class.m,breaks[i-1], breaks[i], i)
  }
  
  # create matrix from vector
  reclass.ht.m <- matrix(ht.class.m,
                         ncol=3,
                         byrow = T)
  
  return(reclass.ht.m)
}


```

```{r PLOT-DENS-WBREAKS}

# plot density of chm with chosen breaks
# expects a chm, title, and vector of breaks

plot_chm_dens <- function(chm,title,breaks){
  density(chm,
          main=title,
          xlab="Height (m)")
  abline(v=breaks,col="red")
  
}

plot_chm_dens(chm,title="CHM of TEAK with set breaks",breaks)

```



# Classify raster

```{r CLASSIFY-RASTER}

# reclassify the raster using the reclass object - rcl.m
chm.class <- reclassify(chm,
                        rcl.m)

# plot density wtih threshold values
density(chm,
        main="Canopy height model distribution\n with class cutoffs",
        xlab="Height (m)")
abline(v=thresh,col="red")


```


# Plot classified raster

```{r}

# make room for a legend
par(xpd = FALSE, mar=c(5.1, 4.1, 4.1, 4.5))

# plot
plot(chm.class,
     col=c("yellow","orange","blue"),
     main="Classified CHM by height",
     legend=F)

# allow legend to plot outside of bounds
par(xpd=TRUE)

# calculate legend position based on where data is plotted
leg.x <- par()$usr[2] + 20
leg.y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4])/2)

# create the legend
legend(leg.x,leg.y,
       legend=c("low","medium","high"),
       fill=c("yellow","orange","blue"),
       bty="n")

```


# Export plot to PDF

```{r EXPORT-PDF}

pdf("../outputs/TEAK/TEAK_CHM_classified.pdf",
    width=7,height=6)

  # make room for a legend
  par(xpd = FALSE, mar=c(5.1, 4.1, 4.1, 4.5))
  
  # plot
  plot(chm.class,
       col=c("yellow","orange","blue"),
       main="Classified CHM by height",
       legend=F)
  
  # allow legend to plot outside of bounds
  par(xpd=TRUE)
  
  # calculate legend position based on where data is plotted
  leg.x <- par()$usr[2] + 20
  leg.y <- par()$usr[4] + 50 - (abs(par()$usr[3] - par()$usr[4])/2)
  
  # create the legend
  legend(leg.x,leg.y,
         legend=c("low","medium","high"),
         fill=c("yellow","orange","blue"),
         bty="n")

dev.off()

```


# Export classified raster to GeoTiff

```{r EXPORT-TIF}

writeRaster(chm.class,"../outputs/TEAK/TEAK_chm_classified.tif",
            format="GTiff",
            NAflag=-9999,
            overwrite=T)

```


```{r SET-UP-INFO}

sessionInfo()

sink(paste0(format(Sys.time(),"%Y-%m-%d_%H%M%S"),
            "_sessionInfo.txt"))
sessionInfo()
sink()

```

